package  cn.com.winning.ssgj.base.interceptor;import cn.com.winning.ssgj.base.Constants;import cn.com.winning.ssgj.base.util.StringUtil;import cn.com.winning.ssgj.dao.EtUserLookProjectDao;import cn.com.winning.ssgj.dao.SysOrgExtDao;import cn.com.winning.ssgj.domain.EtUserLookProject;import cn.com.winning.ssgj.domain.SysLoginUser;import cn.com.winning.ssgj.domain.SysOrgExt;import cn.com.winning.ssgj.domain.SysUserInfo;import cn.com.winning.ssgj.service.SysLoginUserService;import cn.com.winning.ssgj.service.SysUserInfoService;import org.apache.shiro.SecurityUtils;import org.apache.shiro.authc.UsernamePasswordToken;import org.apache.shiro.subject.Subject;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import java.sql.Timestamp;import java.util.Date;/** * Vue 登录拦截 */public class LoginHandlerInterceptor extends HandlerInterceptorAdapter {	@Autowired	private SysLoginUserService sysLoginUserService;	@Autowired	private SysUserInfoService sysUserInfoService;	@Autowired	private EtUserLookProjectDao etUserLookProjectDao;	@Autowired	private SysOrgExtDao sysOrgExtDao;	@Override	public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {		//获取请求的URI		String uri = request.getRequestURI();		//请求不是登录或者登出时候，需要登录用户		if(!Constants.Vue.VUE_LOGIN_URL.equals(uri)				&& !Constants.Vue.VUE_LOGOUT_URL.equals(uri)){			String token = request.getHeader("token");			if(!StringUtil.isEmptyOrNull(token)){				SysLoginUser loginUser = sysLoginUserService.getSysLoginUserBySelectiveKey(token);				SysUserInfo user = sysUserInfoService.getSysUserInfoById(loginUser.getUserId());				EtUserLookProject etUserLookProject = etUserLookProjectDao.selectLastUserLookProject(user.getId());				SysOrgExt orgExt = sysOrgExtDao.selectUserOrgExtByUserOrgId(user.getOrgid());				if(etUserLookProject != null){					user.getMap().put("C_ID",etUserLookProject.getCId());					user.getMap().put("CU_ID",etUserLookProject.getSerialNo());					user.getMap().put("PM_ID",etUserLookProject.getPmId());				}				user.getMap().put("orgExt",orgExt.getOrgNameExt());				request.getSession().setAttribute(Constants.USER_INFO,user);				return super.preHandle(request, response, handler);			}else {				return false;			}		}else if(Constants.Vue.VUE_LOGOUT_URL.equals(uri)){  //登出			String token = request.getHeader("token");			if(!StringUtil.isEmptyOrNull(token)) {				SysLoginUser loginUser = sysLoginUserService.getSysLoginUserBySelectiveKey(token);				loginUser.setLogoutTime(new Timestamp(new Date().getTime()));				sysLoginUserService.modifySysLoginUser(loginUser);			}			request.getSession().removeAttribute(Constants.USER_INFO);			return super.preHandle(request, response, handler);		}		//登录		return super.preHandle(request, response, handler);	}}